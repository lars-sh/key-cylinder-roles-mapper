<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExcelFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Key Cylinder Roles Mapper</a> &gt; <a href="index.source.html" class="el_package">de.larssh.keycylinderroles.mapper.sheets.excel</a> &gt; <span class="el_source">ExcelFiles.java</span></div><h1>ExcelFiles.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Feb 16 00:29:52 UTC 2026
package de.larssh.keycylinderroles.mapper.sheets.excel;

import static de.larssh.utils.Collectors.toLinkedHashMap;
import static java.util.Collections.unmodifiableMap;
import static java.util.stream.Collectors.toSet;
import java.io.IOException;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Map;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.Set;
import java.util.function.Function;
import org.apache.poi.hssf.usermodel.HSSFWorkbookFactory;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.apache.poi.xssf.usermodel.XSSFWorkbookFactory;
import de.larssh.keycylinderroles.mapper.data.Cylinder;
import de.larssh.keycylinderroles.mapper.data.Key;
import de.larssh.keycylinderroles.mapper.data.KeyCylinderPermissions;
import de.larssh.keycylinderroles.mapper.utils.CellValues;
import de.larssh.keycylinderroles.mapper.utils.Workbooks;
import de.larssh.utils.Nullables;
import de.larssh.utils.OptionalInts;
import de.larssh.utils.Optionals;
import de.larssh.utils.annotations.PackagePrivate;
import de.larssh.utils.text.Strings;

@SuppressWarnings({&quot;checkstyle:MultipleStringLiterals&quot;, &quot;PMD.ExcessiveImports&quot;})
public final class ExcelFiles {
	private static final String SHEET_KEYS = &quot;Transponder&quot;;
	private static final String SHEET_KEY_ROLES = &quot;Transponder-Berechtigungen&quot;;
	private static final String SHEET_ROLE_PERMISSIONS = &quot;Rollen-Berechtigungen&quot;;
	private static final String SHEET_CYLINDERS = &quot;Schließzylinder&quot;;
	private static final String COLUMN_KEY_ID = &quot;ID&quot;;
	private static final String COLUMN_KEY_NAME = &quot;Name&quot;;
	private static final String COLUMN_KEY_LAST_NAME = &quot;Nachname&quot;;
	private static final String COLUMN_KEY_FIRST_NAME = &quot;Vorname&quot;;
	private static final String COLUMN_KEY_STATUS = &quot;Status&quot;;
	private static final String COLUMN_CYLINDER_ID = &quot;ID&quot;;
	private static final String COLUMN_CYLINDER_NAME = &quot;Name&quot;;
	private static final String COLUMN_CYLINDER_SECTION = &quot;Bereich&quot;;
	private static final String COLUMN_CYLINDER_BUILDING = &quot;Haus&quot;;
	private static final String COLUMN_CYLINDER_STATUS = &quot;Status&quot;;
	private static final String COLUMN_ROLE_KEY = &quot;Transponder&quot;;
	private static final String COLUMN_ROLE_NAME = &quot;Rolle&quot;;
	private static final String COLUMN_ROLE_CYLINDER = &quot;Schließzylinder&quot;;
	private static final String VALUE_IGNORE = &quot;ignorieren&quot;;

	static {
		// Making sure that both Workbook Factories are registered to support XLS and
		// XLSX. Registering automatically might be a problem when creating a JAR with
		// all dependencies.
<span class="nc" id="L63">		WorkbookFactory.addProvider(new XSSFWorkbookFactory());</span>
<span class="nc" id="L64">		WorkbookFactory.addProvider(new HSSFWorkbookFactory());</span>
<span class="nc" id="L65">	}</span>

	public static KeyCylinderPermissions read(final Path path) throws IOException {
<span class="nc" id="L68">		try (</span>
<span class="nc" id="L69">			InputStream inputStream = Files.newInputStream(path);</span>
<span class="nc" id="L70">			Workbook workbook = WorkbookFactory.create(inputStream)) {</span>
<span class="nc" id="L71">			return new ExcelFileReader(workbook).read();</span>
		}
	}


	private static class ExcelFileReader {
		private static OptionalInt getColumn(final Row row, final String value) {
<span class="nc" id="L78">			final int numberOfColumns = row.getLastCellNum() + 1;</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">			for (int column = row.getFirstCellNum(); column &lt;= numberOfColumns; column += 1) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				if (Strings.equalsIgnoreCaseAscii(CellValues.getAsString(CellValues.create(row.getCell(column), true)), value)) {</span>
<span class="nc" id="L81">					return OptionalInt.of(column);</span>
				}
			}
<span class="nc" id="L84">			return OptionalInt.empty();</span>
		}

		private static Optional&lt;String&gt; getValue(final Row row, final int column) {
<span class="nc" id="L88">			final Cell cell = row.getCell(column);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">			return cell == null ? Optional.empty() : Optionals.ofNonBlank(CellValues.getAsString(CellValues.create(cell, true)));</span>
		}

		private static Optional&lt;String&gt; getValue(final Row row, final OptionalInt column) {
<span class="nc" id="L93">			return OptionalInts.flatMapToObj(column, c -&gt; getValue(row, c));</span>
		}

		private final Workbook workbook;

		@PackagePrivate
		KeyCylinderPermissions read() {
<span class="nc" id="L100">			final Map&lt;String, Key&gt; keys = getKeys();</span>
<span class="nc" id="L101">			final Map&lt;Key, Set&lt;String&gt;&gt; keyRoles = getKeyRoles(keys);</span>
<span class="nc" id="L102">			final Map&lt;String, Cylinder&gt; cylinders = getCylinders();</span>
<span class="nc" id="L103">			final Map&lt;String, Set&lt;Cylinder&gt;&gt; rolePermissions = getRolePermissions(cylinders);</span>
<span class="nc" id="L104">			return getPermissions(keys.values(), keyRoles, cylinders.values(), rolePermissions);</span>
		}

		@SuppressWarnings(&quot;PMD.ShortVariable&quot;)
		private Map&lt;String, Cylinder&gt; getCylinders() {
<span class="nc" id="L109">			final Sheet sheet = workbook.getSheet(SHEET_CYLINDERS);</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			if (sheet == null) {</span>
<span class="nc" id="L111">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L113">			final Row header = sheet.getRow(sheet.getFirstRowNum());</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">			if (header == null) {</span>
<span class="nc" id="L115">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L117">			final int idColumn = getColumn(header, COLUMN_CYLINDER_ID).getAsInt(); // TODO</span>
<span class="nc" id="L118">			final OptionalInt nameColumn = getColumn(header, COLUMN_CYLINDER_NAME);</span>
<span class="nc" id="L119">			final OptionalInt sectionColumn = getColumn(header, COLUMN_CYLINDER_SECTION);</span>
<span class="nc" id="L120">			final OptionalInt buildingColumn = getColumn(header, COLUMN_CYLINDER_BUILDING);</span>
<span class="nc" id="L121">			final OptionalInt statusColumn = getColumn(header, COLUMN_CYLINDER_STATUS);</span>
<span class="nc" id="L122">			return  // TODO: Test filtering out these rows</span>
<span class="nc" id="L123">			Workbooks.rows(sheet).skip(1).map(row -&gt; {</span>
<span class="nc" id="L124">				final Optional&lt;String&gt; id = getValue(row, idColumn);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				if (!id.isPresent()) {</span>
<span class="nc" id="L126">					return null;</span>
				}
<span class="nc" id="L128">				return new Cylinder(id.get(), getValue(row, nameColumn).orElse(&quot;&quot;), getValue(row, sectionColumn), getValue(row, buildingColumn), getValue(row, statusColumn).map(VALUE_IGNORE::equals).orElse(Boolean.FALSE));</span>
<span class="nc" id="L129">			}).collect(toLinkedHashMap(Cylinder::getId, Function.identity()));</span>
		}

		@SuppressWarnings(&quot;PMD.ShortVariable&quot;)
		private Map&lt;String, Key&gt; getKeys() {
<span class="nc" id="L134">			final Sheet sheet = workbook.getSheet(SHEET_KEYS);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			if (sheet == null) {</span>
<span class="nc" id="L136">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L138">			final Row header = sheet.getRow(sheet.getFirstRowNum());</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">			if (header == null) {</span>
<span class="nc" id="L140">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L142">			final int idColumn = getColumn(header, COLUMN_KEY_ID).getAsInt(); // TODO</span>
<span class="nc" id="L143">			final OptionalInt nameColumn = getColumn(header, COLUMN_KEY_NAME);</span>
<span class="nc" id="L144">			final OptionalInt lastNameColumn = getColumn(header, COLUMN_KEY_LAST_NAME);</span>
<span class="nc" id="L145">			final OptionalInt firstNameColumn = getColumn(header, COLUMN_KEY_FIRST_NAME);</span>
<span class="nc" id="L146">			final OptionalInt statusColumn = getColumn(header, COLUMN_KEY_STATUS);</span>
<span class="nc" id="L147">			return  // TODO: Test filtering out these rows</span>
<span class="nc" id="L148">			Workbooks.rows(sheet).skip(1).map(row -&gt; {</span>
<span class="nc" id="L149">				final Optional&lt;String&gt; id = getValue(row, idColumn);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">				if (!id.isPresent()) {</span>
<span class="nc" id="L151">					return null;</span>
				}
<span class="nc" id="L153">				return new Key(id.get(), getValue(row, nameColumn), getValue(row, lastNameColumn), getValue(row, firstNameColumn), Optional.empty(), getValue(row, statusColumn).map(VALUE_IGNORE::equals).orElse(Boolean.FALSE));</span>
<span class="nc" id="L154">			}).collect(toLinkedHashMap(Key::getId, Function.identity()));</span>
		}

		@SuppressWarnings(&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;)
		private Map&lt;Key, Set&lt;String&gt;&gt; getKeyRoles(final Map&lt;String, Key&gt; keys) {
<span class="nc" id="L159">			final Sheet sheet = workbook.getSheet(SHEET_KEY_ROLES);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if (sheet == null) {</span>
<span class="nc" id="L161">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L163">			final Row header = sheet.getRow(sheet.getFirstRowNum());</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">			if (header == null) {</span>
<span class="nc" id="L165">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L167">			final int keyIdColumn = getColumn(header, COLUMN_ROLE_KEY).getAsInt(); // TODO</span>
<span class="nc" id="L168">			final int roleColumn = getColumn(header, COLUMN_ROLE_NAME).getAsInt(); // TODO</span>
<span class="nc" id="L169">			final Map&lt;Key, Set&lt;String&gt;&gt; keyRoles = new HashMap&lt;&gt;();</span>
<span class="nc" id="L170">			final int numberOfRows = sheet.getLastRowNum() + 1;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			for (int rowIndex = sheet.getFirstRowNum() + 1; rowIndex &lt; numberOfRows; rowIndex += 1) {</span>
<span class="nc" id="L172">				final Row row = sheet.getRow(rowIndex);</span>
<span class="nc" id="L173">				final Optional&lt;String&gt; keyId = getValue(row, keyIdColumn);</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">				if (keyId.isPresent()) {</span>
<span class="nc" id="L175">					final Key key = Nullables.orElseThrow(keys.get(keyId.get())); // TODO</span>
<span class="nc" id="L176">					final String role = getValue(row, roleColumn).get(); // TODO</span>
<span class="nc" id="L177">					keyRoles.computeIfAbsent(key, k -&gt; new HashSet&lt;&gt;()).add(role);</span>
				}
			}
<span class="nc" id="L180">			return unmodifiableMap(keyRoles);</span>
		}

		@SuppressWarnings(&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;)
		private Map&lt;String, Set&lt;Cylinder&gt;&gt; getRolePermissions(final Map&lt;String, Cylinder&gt; cylinders) {
<span class="nc" id="L185">			final Sheet sheet = workbook.getSheet(SHEET_ROLE_PERMISSIONS);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (sheet == null) {</span>
<span class="nc" id="L187">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L189">			final Row header = sheet.getRow(sheet.getFirstRowNum());</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (header == null) {</span>
<span class="nc" id="L191">				throw new IllegalArgumentException(); // TODO</span>
			}
<span class="nc" id="L193">			final int roleColumn = getColumn(header, COLUMN_ROLE_NAME).getAsInt(); // TODO</span>
<span class="nc" id="L194">			final int cylinderIdColumn = getColumn(header, COLUMN_ROLE_CYLINDER).getAsInt(); // TODO</span>
<span class="nc" id="L195">			final Map&lt;String, Set&lt;Cylinder&gt;&gt; rolePermissions = new HashMap&lt;&gt;();</span>
<span class="nc" id="L196">			final int numberOfRows = sheet.getLastRowNum() + 1;</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">			for (int rowIndex = sheet.getFirstRowNum() + 1; rowIndex &lt; numberOfRows; rowIndex += 1) {</span>
<span class="nc" id="L198">				final Row row = sheet.getRow(rowIndex);</span>
<span class="nc" id="L199">				final Optional&lt;String&gt; cylinderId = getValue(row, cylinderIdColumn);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">				if (cylinderId.isPresent()) {</span>
<span class="nc" id="L201">					final Cylinder cylinder = Nullables.orElseThrow(cylinders.get(cylinderId.get())); // TODO</span>
<span class="nc" id="L202">					final String role = getValue(row, roleColumn).get(); // TODO</span>
<span class="nc" id="L203">					rolePermissions.computeIfAbsent(role, k -&gt; new HashSet&lt;&gt;()).add(cylinder);</span>
				}
			}
<span class="nc" id="L206">			return unmodifiableMap(rolePermissions);</span>
		}

		@SuppressWarnings(&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;)
		private KeyCylinderPermissions getPermissions(final Collection&lt;Key&gt; keys, final Map&lt;Key, Set&lt;String&gt;&gt; keyRoles, final Collection&lt;Cylinder&gt; allCylinders, final Map&lt;String, Set&lt;Cylinder&gt;&gt; rolePermissions) {
<span class="nc" id="L211">			final Map&lt;Key, Set&lt;Cylinder&gt;&gt; permissions = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">			for (final Key key : keys) {</span>
<span class="nc" id="L213">				final Set&lt;String&gt; roles = keyRoles.get(key);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">				if (roles != null) {</span>
					// Copying all cylinders to retain the original order, then remove all not
					// permitted cylinders
<span class="nc" id="L217">					final Set&lt;Cylinder&gt; cylinders = new HashSet&lt;&gt;(allCylinders);</span>
<span class="nc" id="L218">					cylinders.retainAll(roles.stream().flatMap(role -&gt; Nullables.orElseGet(rolePermissions.get(role), Collections::emptySet).stream()).collect(toSet()));</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">					if (!cylinders.isEmpty()) {</span>
<span class="nc" id="L220">						permissions.put(key, cylinders);</span>
					}
				}
<span class="nc" id="L223">			}</span>
<span class="nc" id="L224">			return new KeyCylinderPermissions(keys, allCylinders, permissions);</span>
		}

		@java.lang.SuppressWarnings(&quot;all&quot;)
		@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
		@lombok.Generated
		ExcelFileReader(final Workbook workbook) {
			this.workbook = workbook;
		}
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private ExcelFiles() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>